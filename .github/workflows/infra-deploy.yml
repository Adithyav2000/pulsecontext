name: Infra Deploy

on:
  repository_dispatch:
    types: [deploy-backend]
  workflow_dispatch: {}

jobs:
  deploy:
    name: Deploy infra (remote)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse payload
        id: payload
        run: |
          echo "RECEIVED=${{ toJson(github.event) }}"
          IMAGE_TAG=$(echo '${{ toJson(github.event.client_payload) }}' | sed -n 's/.*image_tag":\"\([^\"]*\)\".*/\1/p')
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Deploy to host via SSH
        if: secrets.DEPLOY_SSH_HOST && secrets.DEPLOY_SSH_USER && secrets.DEPLOY_SSH_KEY
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          script: |
            set -e
            echo "Deploying pulsecontext backend image: ${{ steps.payload.outputs.image_tag }}"
            cd ~/deploy/pulsecontext || exit 0
            # If your remote infra uses docker compose, update the image tag in compose or use env override
            docker pull ${REGISTRY:-}pulsecontext-backend:${{ steps.payload.outputs.image_tag }} || true
            docker compose pull || true
            docker compose up -d --no-build
            docker ps --filter name=infra-db-1 || true

      - name: Post-deploy health check
        if: always() && secrets.DEPLOY_SSH_HOST && secrets.DEPLOY_SSH_USER && secrets.DEPLOY_SSH_KEY
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          script: |
            curl -fS --max-time 10 http://localhost:8000/health && echo 'HEALTH_OK' || echo 'HEALTH_FAIL'

# NOTES:
# - This workflow expects deploy credentials as secrets in the infra repository:
#   - DEPLOY_SSH_HOST, DEPLOY_SSH_USER, DEPLOY_SSH_KEY (private key), optional DEPLOY_SSH_PORT
# - Adjust remote commands to match your deployment layout (paths, compose files, environment).
